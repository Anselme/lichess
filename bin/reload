#!/bin/sh

show_run()
{
    echo "    $ $*"
    result=$($*)
    if [ $? -ne  0 ]; then
        echo "--- FAIL"
        echo $result
        exit 1
    fi
}

echo -e "\n--- Building bootstrap"
show_run "bin/build_bootstrap.php"

for application in xhr lichess; do
    echo -e "\n------------------- $application -----------------"

    if [ ! -f lichess/config/config_local.yml ]; then
        echo -e "\n--- Creating local configuration file for $application"
        show_run cp $application/config/config_local.yml.dist $application/config/config_local.yml
    fi

    echo -e "\n--- Warming up the cache"
    show_run "php $application/console cache:clear"
done

echo -e "\n--- Loading dev fixtures"
show_run "php lichess/console --env=dev doctrine:mongodb:data:load"

echo -e "\n--- Creating dev MongoDB standard indexes"
show_run "php lichess/console --env=dev doctrine:mongodb:schema:create --index"

echo -e "\n--- Creating assets symlinks"
show_run php lichess/console assets:install web --symlink

# Show a cow saying something smart.
curl --connect-timeout 1 -s "http://lichess.org/fortune.php?cowsay=1" 2>/dev/null
